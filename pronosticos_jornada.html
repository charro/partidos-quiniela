<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados de Las Rubias para la Quiniela</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }
        h1 {
            text-align: center;
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        #jornada-header {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #007bff;
            font-weight: bold;
        }
        #results-container {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f0f0f0;
            color: #333;
        }
        td.match-name {
            font-weight: bold;
        }
        td.prediction {
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .prediction-value {
            color: #28a745; /* Color por defecto para 1, X, 2 */
            font-size: 1.2em;
        }
        /* Nuevo estilo para la Triple Sugerida */
        .prediction-value.triple-suggested {
            color: #ff9800; /* Naranja para advertir sobre el Triple */
            font-size: 1.1em;
        }
        .prediction-author {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }
        #loading-message {
            text-align: center;
            font-size: 1.2em;
            color: #6c757d;
            padding: 50px;
        }
    </style>
</head>
<body>

    <h1>Pronóstico Consolidado por Consenso (Las Rubias)</h1>

    <div id="loading-message">Cargando datos... ⏳</div>

    <div id="jornada-header"></div>

    <div id="results-container" style="display:none;">
        <table>
            <thead>
                <tr>
                    <th style="width: 5%;">Nº</th>
                    <th style="width: 55%;">Partido</th>
                    <th style="width: 40%; text-align: center;">Consenso</th>
                </tr>
            </thead>
            <tbody id="results-table-body">
                </tbody>
        </table>
        <p style="font-size: 0.85em; margin-top: 20px;">
            * El consenso se calcula por **mayoría de votos**. En caso de empate, se utiliza el último pronóstico enviado.
            * Si se sugiere **TRIPLE**, es porque hay alta diversidad (mínimo 3 votos para cada opción).
        </p>
    </div>

    <script>
        // URL del Google Script (GET)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHNYbQoVUri74sLtB_j7nkPxg7yAhIFd0hsn4oWN0gBJgZCBVWYAP1Vfm3AGAmFs9E/exec";

        // URL del JSON de partidos
        const MATCH_DATA_URL = 'https://gist.githubusercontent.com/charro/d6b5be152cf5e3f6ebb02f2daa60f291/raw/790ed8ca4e3f7916bf4c0c76a1e416aef30e273b/partidos.json';

        const loadingMessage = document.getElementById('loading-message');
        const jornadaHeader = document.getElementById('jornada-header');
        const resultsContainer = document.getElementById('results-container');
        const resultsTableBody = document.getElementById('results-table-body');
        const MAX_MATCHES = 15;

        /**
         * Realiza ambas peticiones, las combina y renderiza los resultados.
         */
        async function loadAndRenderResults() {
            loadingMessage.style.display = 'block';
            resultsContainer.style.display = 'none';
            jornadaHeader.textContent = '';
            resultsTableBody.innerHTML = '';

            try {
                // 1. Petición para obtener los nombres de los partidos
                const matchResponse = await fetch(MATCH_DATA_URL);
                if (!matchResponse.ok) throw new Error("Error al cargar la lista de partidos.");
                const matchDataObject = await matchResponse.json();
                const matchNames = matchDataObject.partidos.slice(0, MAX_MATCHES);
                if (matchNames.length === 0) throw new Error("La lista de partidos está vacía.");

                // 2. Petición para obtener los pronósticos consolidados (por consenso)
                const scriptResponse = await fetch(GOOGLE_SCRIPT_URL);
                if (!scriptResponse.ok) throw new Error("Error al llamar al Google Script.");

                const scriptData = await scriptResponse.json();

                if (scriptData.status !== 'success') {
                    throw new Error(scriptData.message || "Error desconocido en el script.");
                }

                const jornada = scriptData.jornada;
                const consolidatedData = scriptData.pronosticos_consolidados;

                // 3. Renderizar la cabecera de la jornada
                jornadaHeader.textContent = `Jornada Nº ${jornada}`;

                // 4. Combinar y renderizar los resultados
                for (let i = 0; i < MAX_MATCHES; i++) {
                    const matchNumber = (i + 1).toString();
                    const partido = matchNames[i];

                    // Obtener los datos consolidados (incluye valor y explicación)
                    const data = consolidatedData[matchNumber] || { value: "—", author: "Sin datos" };
                    const pronostico = data.value;
                    const explicacion = data.author || ""; // 'author' ahora lleva la explicación (ej: "(5 votos)")

                    const isTriple = pronostico.includes("TRIPLE");
                    const isPronounced = pronostico !== "—";

                    const row = resultsTableBody.insertRow();

                    // Columna 1: Número de Partido
                    let cell1 = row.insertCell();
                    cell1.textContent = matchNumber;

                    // Columna 2: Nombres de Equipos
                    let cell2 = row.insertCell();
                    cell2.classList.add('match-name');
                    cell2.textContent = `${partido.local} - ${partido.visitante}`;

                    // Columna 3: Pronóstico y Explicación
                    let cell3 = row.insertCell();
                    cell3.classList.add('prediction');

                    // Valor del pronóstico
                    let valueSpan = document.createElement('span');
                    valueSpan.classList.add('prediction-value');

                    if (isTriple) {
                        valueSpan.classList.add('triple-suggested');
                        valueSpan.textContent = "TRIPLE"; // Mostramos solo "TRIPLE" para que sea grande
                    } else {
                        valueSpan.textContent = pronostico;
                    }

                    // Explicación/Autor (votos, desempate, o desglose del triple)
                    let authorSpan = document.createElement('span');
                    authorSpan.classList.add('prediction-author');

                    if (isTriple) {
                        // Para el triple, mostramos el detalle de los votos
                        authorSpan.textContent = `Sugerido: ${explicacion}`;
                    } else if (isPronounced) {
                        // Para 1, X, 2, mostramos el número de votos o el desempate
                        authorSpan.textContent = explicacion;
                    } else {
                        authorSpan.textContent = "Sin votos registrados";
                    }

                    cell3.appendChild(valueSpan);
                    cell3.appendChild(authorSpan);
                }

                // Mostrar la tabla y ocultar el mensaje de carga
                loadingMessage.style.display = 'none';
                resultsContainer.style.display = 'block';

            } catch (error) {
                console.error('Error general:', error);
                loadingMessage.textContent = `❌ Error al cargar los resultados: ${error.message}`;
                loadingMessage.style.color = '#dc3545';
                loadingMessage.style.display = 'block';
            }
        }

        // Ejecutar la carga al iniciar
        loadAndRenderResults();
    </script>

</body>
</html>